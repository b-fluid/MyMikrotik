 Voici une ancienne version de mon script de pare-feu que je rends public.
#
# Ceci est compilé à partir d'une expérience wiki / forum / personnelle.
#
# Il bloque le trafic entrant frauduleux, inclut certaines règles de portknock, le blocage du courrier indésirable SMTP, certaines limitations de débit ICMP,
# bloque certaines analyses de ports et les attaques DOS.
#
# Dans le script ci-dessous, remplacez X.X.X.X, Y.Y.Y.Y et Z.Z.Z.Z par vos propres valeurs. Le port frappé à la ligne 34 commence à la ligne 42.
# Si vous souhaitez la désactiver, ce sont vos lignes à ajuster. Vous voudrez probablement ajuster le port et les protocoles sur le port si vous choisissez de l'utiliser
#
#
# De plus ci-dessous, nous avons la liste des Bogons.
# Mais tout d’abord Kezako que le Bogons ??? 
# Un Bogon est une adresse IP bidon à partir de l’espace Bogon, qui est un ensemble d’adresses IP qui n’est pas encore officiellement attribuée à une entité par l’Internet
# Assigned numéro Authority (IANA) ou un Institut régional d’enregistrement Internet.
# Les adresses IP de Bogon sont des adresses légitimes. Vous pouvez voir une adresse IP Bogon à la suite d’une mauvaise configuration (intentionnelle ou involontaire) qui
# imbéciles un destinataire sur l’adresse IP légitime d’un expéditeur. Les adresses IP de Bogon sont populaires dans le piratage ou les activités malveillantes et sont
# utilisées par les spammeurs et ceux qui lancent des attaques par déni de service distribué. En tant que tel, de nombreux fournisseurs de services Internet et pare-feu bloquent bogons.
# Un Bogon est également connu comme un espace Bogon ou une adresse IP Bogon.
# Les adresses IP constituent le composant central de toute l'infrastructure Internet et intranet à travers le monde. Ils permettent d'identifier de manière unique un site Web,
# un serveur ou tout autre appareil ou appareil connecté. Ces adresses sont utilisées pour établir la communication entre les clients et les applications.
# L'IANA attribue des adresses IP uniques à chaque instance et nœud résidant sur ce réseau hétérogène. La plage d'adresses IP allouées ou enregistrées à une entité quelconque
# fait partie de l'espace réservé aux adresses IP. D'autre part, toute autre adresse qui fait partie de l'espace d'adressage mais n'est pas encore enregistrée provient de cet espace.
# Toute adresse dans l'espace bogon est appelée bogon ou adresse IP bogon.
# Les adresses IP des espaces Bogon ne sont normalement pas visibles sur Internet ou sur un réseau informatique, mais elles sont toujours exploitées, principalement pour des activités
# illégales ou frauduleuses. Les pirates informatiques manipulent l'adresse IP source sur une adresse IP erronée, donnant ainsi au destinataire l'impression que le paquet provient d'une source fiable.
# Donc interdire clairement toutes les plages d’adresses dont on ne se sert pas. Et n’autoriser les IP LAN, WAN et VLAN dont notre réseau a besoin. Ne pas oublier le Vlan car on peut galérer un moment.
# Donc:
#
/ip firewall address-list
#rfc 1918, loopback, and multicast
add address=10.0.0.0/8 comment=" ### Private[RFC 1918] - CLASS A - loopback, and multicast # Vérifiez si vous avez besoin de ce sous-réseau avant de l’activer ou le desactiver ### " disabled=no list=bogons
add address=127.0.0.1 comment=" ### Loopback [RFC 3330] ### " disabled=no list=bogons
add address=169.254.0.0/16 comment=" ### Link Local [RFC 3330] ### " disabled=no list=bogons
add address=192.168.0.0/16 comment=" ### Private[RFC 1918] - CLASS C # Vérifiez si vous avez besoin de ce sous-réseau avant de l’activer ou le desactiver ###" disabled=no list=bogons
add address=172.16.0.0/20 comment="" disabled=no list=bogons
add address=10.0.0.0/8 comment="" disabled=no list=bogons
add address=172.16.0.0/12 comment=" ### Private[RFC 1918] - CLASS B # Vérifiez si vous avez besoin de ce sous-réseau avant de l’activer ou le desactiver ### " disabled=no list=bogons
add address=192.0.2.0/24 comment=" ### Reserved - IANA - TestNet1 ### " disabled=no  list=bogons
add address=192.88.99.0/24 comment=" ### 6to4 Relay Anycast [RFC 3068] ### " disabled=no  list=bogons
add address=198.18.0.0/15 comment=" ### NIDB Testing ### " disabled=no  list=bogons
add address=198.51.100.0/24 comment=" ### Reserved - IANA - TestNet2 ### " disabled=no  list=bogons
add address=203.0.113.0/24 comment=" ### Reserved - IANA - TestNet3 ### " disabled=no  list=bogons
add address=224.0.0.0/4 comment=" ### MC, Class D, IANA # Vérifiez si vous avez besoin de ce sous-réseau avant de l’activer ou le désactiver ### " disabled=yes  list=bogons
add address=240.0.0.0/4 comment="" disabled=no list=bogons
 
# my public addressing
add address=217.70.184.38 comment="Domain directional-driller.com heberge chez Gandi.net" disabled=no list=public-add
add address=217.70.184.38 comment="Domain francoisthirion.com heberge chez Gandi.net" disabled=no list=public-add
add address=217.70.184.38 comment="Domain quad9.fr heberge chez Gandi.net" disabled=no list=public-add
add address=217.70.184.38 comment="Domain directional-driller.com heberge chez Gandi.net" disabled=no list=public-add
 
#my private addressing
#  add address=S.S.S.S/SS comment="" disabled=no list=internal-nets
add address=10.0.0.0/8 disabled=no list=internal-nets
add address=192.168.0.0/16 disabled=no list=internal-nets
add address=172.25.25.0/24 disabled=no list=internal-nets

#any port knock exclusions
add address=Y.Y.Y.Y comment="" disabled=no list=port-knock-3
 
#any SMTP exclusions
add address=Z.Z.Z.Z comment="" disabled=no list=smtp-bypass
#
/ip firewall nat
add action=masquerade chain=srcnat out-interface=ether1
# 
/ip firewall filter
# Match more than 5 pings in 5 seconds.  Then drop the traffic inbound and forward.
#
add action=accept chain=input comment="start of greg rules up to 5 pings in 5 seconds" disabled=no limit=5,5 protocol=icmp
add action=add-src-to-address-list address-list=icmp-attack address-list-timeout=12h chain=input comment="add all other icmp input into icmp-attack address list." disabled=no protocol=icmp
add action=drop chain=input comment=" ### drop excessive icmp traffic for 12 hours / Refuser tout traffic excessif en ICMP pour 12 hrs. ### " disabled=no src-address-list=icmp-attack protocol=icmp
add action=drop chain=forward comment=" ### drop excessive icmp traffic for 12 hours / Refuser tout traffic excessif en ICMP pour 12 hrs. ### " disabled=yes src-address-list=icmp-attack protocol=icmp
#
#drop 1918 inbound (bogons)
#
add action=drop chain=forward comment="block rfc 1918 and multicast inbound" disabled=no in-interface=ether1 src-address-list=bogons
add action=drop chain=forward comment="block our addressing inbound - spoofed" disabled=no in-interface=ether1 src-address-list=public-add
add action=drop chain=input comment="block rfc 1918 and multicast inbound" disabled=no in-interface=ether1 src-address-list=bogons
add action=drop chain=input comment="block our addressing inbound - spoofed" disabled=no in-interface=ether1 src-address-list=public-add
#
# Basic configuration
#
add action=drop chain=input comment=" ### Drop DNS requests from public / Refuse les requetes DNS provenant du reseau public protocole TCP ### " connection-state=new dst-port=53 in-interface=ether1 protocol=tcp
add action=drop chain=input comment=" ### Drop DNS requests from public / Refuse les requetes DNS provenant du reseau public protocole UDP ### " connection-state=new dst-port=53 in-interface=ether1 protocol=udp

add action=drop chain=input comment=" ### Drop DNS requests from public / Refuse les requetes DNS provenant du reseau public protocole TCP ### " connection-state=new dst-port=53 in-interface=wlan1 protocol=tcp
add action=drop chain=input comment=" ### Drop DNS requests from public / Refuse les requetes DNS provenant du reseau public protocole UDP ### " connection-state=new dst-port=53 in-interface=wlan1 protocol=udp

add action=drop chain=input comment=" ### Disallow weird packets / Interdire les paquets bizarres ### " connection-state=invalid
add action=accept chain=input comment=" ### Allow LAN access to router and Internet / Autoriser l’accès à la LAN au routeur et à Internet ### " connection-state=new in-interface=bridge1-LAN
add action=fasttrack-connection chain=forward comment="FastTrack Established and Related" connection-state=established,related
add action=accept chain=input comment="Allow connections that originated from LAN" connection-state=established
add action=accept chain=input comment="Allow connections that originated from LAN" connection-state=related
add action=accept chain=input comment="Allow ping ICMP from anywhere" protocol=icmp
add action=accept chain=input comment=" ### Allow WAN access to router / permettre les acces WAN vers le router ### " dst-port=8291 protocol=tcp
add action=drop chain=input comment="Disallow anything from anywhere on any interface"
add action=drop chain=forward comment="Disallow weird packets" connection-state=invalid
#
#
#start port knocking
#
# Le port « knock » lui-même est similaire à une poignée de main secrète et peut considt de n’importe quel nombre de TCP, UDP, ou ICMP ou d’autres paquets de protocole à des ports numérotés
# sur la machine de destination.
# Le KNock peut également consister en des chaînes de texte envoyées à l’appareil en cours de frappe pour ajouter une complexité et une sécurité supplémentaires.
# Exemple de frappe de port :
# L'hote  envoie une connexion à l’un des ports du routeur, le routeur stocke l’ADRESSE IP du demandeur pendant un certain temps.
# Si l’hôte envoie à nouveau une connexion dans les autres ports, le routeur vérifie si l’IP est la même IP à partir de la première connexion.
# Si l’IP est la même et que le temps entre le premier attemp et le second est dans un délai spécifié, l’IP du demandeur sera autorisé à accéder au routeur.
# et ca s ecrit ainsi

add action=add-src-to-address-list address-list=ICMP address-list-timeout=1m chain=input disabled=no protocol=icmp
add action=add-src-to-address-list address-list="ICMP + Http" address-list-timeout=1m chain=input disabled=no dst-port=80 protocol=tcp src-address-list=ICMP
add  action=drop chain=input disabled=no dst-port=22,23,8291 protocol=tcp src-address-list="!ICMP + Http"
#
add action=add-src-to-address-list address-list=port-knock-1 address-list-timeout=15s chain=input comment="port knock step 1 - udp 444" disabled=no dst-port=444 protocol=udp
add action=add-src-to-address-list address-list=port-knock-2 address-list-timeout=15s chain=input comment="port knock step 2 - udp 117" disabled=no dst-port=117 protocol=udp src-address-list=port-knock-1
add action=add-src-to-address-list address-list=port-knock-3 address-list-timeout=5h chain=input comment="port knock step 3 - tcp 600 - final" disabled=no dst-port=600 protocol=tcp src-address-list=port-knock-2
add action=accept chain=input comment="allow winbox in via port knock" disabled=no dst-port=8291 protocol=tcp src-address-list=port-knock-3
add action=drop chain=input comment="allow winbox in via port knock" disabled=no dst-port=8291 protocol=tcp
#
# port scans and DOS
#
add action=add-src-to-address-list address-list=port-scan address-list-timeout=2w chain=input comment="add port scannes to port-scan list" disabled=no in-interface=ether1 protocol=tcp psd=21,3s,3,1 src-address-list=!internal-nets
add action=add-src-to-address-list address-list=port-scan address-list-timeout=2w chain=input comment="NMAP FIN Stealth scan" disabled=no protocol=tcp tcp-flags=fin,!syn,!rst,!psh,!ack,!urg
add action=add-src-to-address-list address-list=port-scan address-list-timeout=2w chain=input comment="SYN/FIN scan" disabled=no protocol=tcp tcp-flags=fin,syn
add action=add-src-to-address-list address-list=port-scan address-list-timeout=2w chain=input comment="SYN/RST scan" disabled=no protocol=tcp tcp-flags=syn,rst
add action=add-src-to-address-list address-list=port-scan address-list-timeout=2w chain=input comment="FIN/PSH/URG scan" disabled=no protocol=tcp tcp-flags=fin,psh,urg,!syn,!rst,!ack
add action=add-src-to-address-list address-list=port-scan address-list-timeout=2w chain=input comment="ALL/ALL scan" disabled=no protocol=tcp tcp-flags=fin,syn,rst,psh,ack,urg
add action=add-src-to-address-list address-list=port-scan address-list-timeout=2w chain=input comment="NMAP NULL scan" disabled=no protocol=tcp tcp-flags=!fin,!syn,!rst,!psh,!ack,!urg
add action=tarpit chain=input comment="tarpit port-scan address list to router" disabled=no protocol=tcp src-address-list=port-scan
add action=drop chain=input comment="drop port-scan address list to our router" disabled=no src-address-list=port-scan
add action=drop chain=forward comment="drop port-scan address list to our infrastructure" disabled=no src-address-list=port-scan
add action=drop chain=forward comment="drop windows ports" disabled=no port=135-139 protocol=tcp
add action=accept chain=forward comment="allow smtp-bypass list to create multiple sessions" disabled=no dst-port=25 protocol=tcp src-address-list=smtp-bypass
add action=drop chain=forward comment="drop smtp traffic marked as spam" disabled=no dst-port=25 protocol=tcp src-address-list=spam-block
add action=add-src-to-address-list address-list=spam-block address-list-timeout=2h chain=forward comment="more than 5 smtp connections out as spam. add to address list" connection-limit=30,32 disabled=no dst-port=25 limit=50,5 protocol=tcp src-address-list=bogons
add action=accept chain=input comment=" ### Accepter les ports 80 et 8080 provenant de portknock / allow 80 and 8080 from portknock ### " disabled=no dst-port=80,8080 protocol=tcp src-address-list=port-knock-3
add action=drop chain=input comment="block 80 and 8080 from everyone else" disabled=no dst-port=80,8080 protocol=tcp
#
# Règle l7 dans la chaîne de sortie qui voit les paquets sortants et entrant.
#
add action=accept chain=input comment="" disabled=no layer7-protocol=telnet protocol=tcp
add action=passthrough chain=output comment="" disabled=no layer7-protocol=telnet protocol=tcp
#
# Firewall regles mangle
#
/ip firewall mangle
add action=mark-packet chain=prerouting comment=" ### internal-traffic packet mark / marquage de paquets du traffic internet ### " dst-address-list=internal-nets new-packet-mark=internal-traffic passthrough=no src-address-list=internal-nets
add action=mark-packet chain=prerouting comment=" ### admin-in packet mark DNS / admin-in des paquest marque DNS sur port 53 UDP ### " in-interface=ether1 new-packet-mark=admin-in passthrough=no protocol=udp src-port=53
add action=mark-packet chain=prerouting comment=" ### admin-in packet mark snmp / admin-in des paquets marques smnp sur port 161 UDP ### " dst-port=161 in-interface=ether1 new-packet-mark=admin-in passthrough=no protocol=udp
add action=mark-connection chain=prerouting comment=" ### Remote Protocols admin connection mark / Protocole de remote access admin marquage deconnection en TCP ### " new-connection-mark=admin port=20,21,22,23,3389,8291 protocol=tcp
add action=mark-connection chain=prerouting comment=" ### icmp connection mark as admin / Preroute les connections marques ICMP comme admin ### " new-connection-mark=admin protocol=icmp src-address-list=internal-nets
add action=mark-packet chain=prerouting comment=" ### admin-in packet mark / Preroute les paquests marques admin-in ### " connection-mark=admin in-interface=ether1 new-packet-mark=admin-in passthrough=no
add action=mark-packet chain=prerouting comment=" ### admin-out packet mark ### " connection-mark=admin new-packet-mark=admin-out passthrough=no
add action=mark-connection chain=prerouting comment=" ### streaming video connection mark ### " dst-port=80 layer7-protocol=video new-connection-mark=streaming-video protocol=tcp src-address-list=internal-nets
add action=mark-packet chain=prerouting comment=" ### streaming video in packet mark ### " connection-mark=streaming-video in-interface=ether1 new-packet-mark=streaming-video-in passthrough=no
add action=mark-packet chain=prerouting comment=" ### streaming video out packet mark ### " connection-mark=streaming-video new-packet-mark=streaming-video-out passthrough=no
add action=mark-connection chain=prerouting comment=" ### http traffic connection mark ### " dst-port=80,443 new-connection-mark=http protocol=tcp src-address-list=internal-nets
add action=mark-connection chain=prerouting comment=" ### http traffic connection mark ### " connection-bytes=5000000-4294967295 dst-port=80,443 new-connection-mark=http-download protocol=tcp src-address-list=internal-nets
add action=mark-packet chain=prerouting comment=" ### http in packet mark ### " connection-mark=http in-interface=ether1 new-packet-mark=http-in passthrough=no
add action=mark-packet chain=prerouting comment=" ### http out packet mark### " connection-mark=http new-packet-mark=http-out passthrough=no
#
# Regles Mangle Cocernat les jeux
#
add action=mark-connection chain=prerouting comment=" ### wow connetion mark as gaming ###" dst-port=1119,3724,6112-6114,4000,6881-6999 new-connection-mark=games protocol=tcp src-address-list=internal-nets
add action=mark-connection chain=prerouting comment=" ### eve online connetion mark as gaming ### " dst-address=87.237.38.200 new-connection-mark=games src-address-list=internal-nets
add action=mark-connection chain=prerouting comment=" ### starcraft 2 connetion mark as gaming ### " dst-port=1119 new-connection-mark=games protocol=tcp src-address-list=internal-nets
add action=mark-connection chain=prerouting comment=" ### heros of newerth connetion mark as gaming ### " dst-port=11031,11235-11335 new-connection-mark=games protocol=tcp src-address-list=internal-nets
add action=mark-connection chain=prerouting comment=" ### steam connetion mark as gaming ### " dst-port=27014-27050 new-connection-mark=games protocol=tcp src-address-list=internal-nets
add action=mark-connection chain=prerouting comment=" ###xbox live connetion mark as gaming ### " dst-port=3074 new-connection-mark=games protocol=tcp src-address-list=internal-nets
add action=mark-connection chain=prerouting comment=" ###ps3 online connetion mark as gaming ###" dst-port=5223 new-connection-mark=games protocol=tcp src-address-list=internal-nets
add action=mark-connection chain=prerouting comment=" ### wii online connetion mark as gaming ### " dst-port=28910,29900,29901,29920 new-connection-mark=games protocol=tcp src-address-list=internal-nets
add action=mark-packet chain=prerouting comment="games packet mark forever-saken-game" dst-address-list=external-nets new-packet-mark=games-in passthrough=no src-address-list=forever-saken-game
add action=mark-packet chain=prerouting comment="games packet mark wow" dst-address-list=external-nets new-packet-mark=games-in passthrough=no protocol=udp src-port=53,3724
add action=mark-packet chain=prerouting comment="games packet mark starcraft2" dst-address-list=external-nets new-packet-mark=games-in passthrough=no protocol=udp src-port=1119,6113
add action=mark-packet chain=prerouting comment="games packet mark HoN" dst-address-list=external-nets new-packet-mark=games-in passthrough=no protocol=udp src-port=11031,11235-11335
add action=mark-packet chain=prerouting comment="games packet mark steam in" dst-address-list=external-nets new-packet-mark=games-in passthrough=no port=4380,28960,27000-27030 protocol=udp
add action=mark-packet chain=prerouting comment="games packet mark steam out" dst-port=53,1500,3005,3101,3478,4379-4380,4380,28960,27000-27030,28960 new-packet-mark=games-out passthrough=no protocol=udp src-address-list=internal-nets
add action=mark-packet chain=prerouting comment="games packet mark xbox live" dst-address-list=external-nets new-packet-mark=games-in passthrough=no protocol=udp src-port=88,3074,3544,4500
add action=mark-packet chain=prerouting comment="games packet mark ps3 online" dst-address-list=external-nets new-packet-mark=games-in passthrough=no protocol=udp src-port=3478,3479,3658
add action=mark-packet chain=prerouting comment="games packet mark in" connection-mark=games dst-address-list=external-nets new-packet-mark=games-in passthrough=no
add action=mark-packet chain=prerouting comment="games packet mark out" connection-mark=games new-packet-mark=games-out passthrough=no
#
# Regles Mangle Concernant les Voice IP
#
add action=mark-packet chain=prerouting comment="voip-in packet mark teamspeak" dst-address-list= external-nets new-packet-mark=voip-in passthrough=no protocol=udp src-port=9987
add action=mark-packet chain=prerouting comment="voip-out packet mark teamspeak" dst-port=9987 new-packet-mark=voip-out passthrough=no protocol=udp src-address-list=internal-nets
add action=mark-packet chain=prerouting comment="voip-out packet mark teamspeak" dst-address-list=external-nets new-packet-mark=voip-in passthrough=no protocol=udp src-port=9987
add action=mark-packet chain=prerouting comment="voip-in packet mark ventrilo" dst-address-list=external-nets new-packet-mark=voip-in passthrough=no protocol=udp src-port=3784
add action=mark-packet chain=prerouting comment="voip-out packet mark ventrilo" dst-port=3784 new-packet-mark=voip-out passthrough=no protocol=udp src-address-list=internal-nets
add action=mark-packet chain=prerouting comment="voip-in packet mark ventrilo" dst-address-list=external-nets new-packet-mark=voip-in passthrough=no protocol=tcp src-port=3784
add action=mark-packet chain=prerouting comment="voip-out packet mark ventrilo" dst-port=3784 new-packet-mark=voip-out passthrough=no protocol=tcp src-address-list=internal-nets
add action=mark-packet chain=prerouting comment="voip-in packet mark SIP" dst-address-list=internal-nets new-packet-mark=voip-in passthrough=no port=5060 protocol=tcp
add action=mark-packet chain=prerouting comment="voip-out packet mark SIP" new-packet-mark=voip-out passthrough=no port=5060 protocol=tcp src-address-list=internal-nets
add action=mark-packet chain=prerouting comment="voip-in packet mark udp SIP" dst-address-list=internal-nets new-packet-mark=voip-in passthrough=no port=5004,5060 protocol=udp
add action=mark-packet chain=prerouting comment="voip-out packet mark udp SIP" new-packet-mark=voip-out passthrough=no port=5004,5060 protocol=udp src-address-list=internal-nets
add action=mark-packet chain=prerouting comment="voip-in packet mark RTP" dst-address-list=internal-nets new-packet-mark=voip-in packet-size=100-400 passthrough=no port=16348-32768 protocol=udp
add action=mark-packet chain=prerouting comment="voip-out packet mark RTP" new-packet-mark=voip-in packet-size=100-400 passthrough=no port=16348-32768 protocol=udp src-address-list=internal-nets
#
# Regles Mangles concernant les VPN
#

add action=mark-packet chain=prerouting comment="vpn-in packet mark GRE" in-interface=ether1 new-packet-mark=vpn-in passthrough=no protocol=gre
add action=mark-packet chain=prerouting comment="vpn-out packet mark GRE" new-packet-mark=vpn-out passthrough=no protocol=gre
add action=mark-packet chain=prerouting comment="vpn-in packet mark ESP" in-interface=ether1 new-packet-mark=vpn-in passthrough=no protocol=ipsec-esp
add action=mark-packet chain=prerouting comment="vpn-out packet mark ESP" new-packet-mark=vpn-out passthrough=no protocol=ipsec-esp
add action=mark-packet chain=prerouting comment="vpn-in packet mark VPN UDP ports" in-interface=ether1 new-packet-mark=vpn-in passthrough=no protocol=udp src-port=500,1701,4500
add action=mark-packet chain=prerouting comment="vpn-out packet mark VPN UDP ports"  new-packet-mark=vpn-out passthrough=no protocol=udp src-port=500,1701,4500
add action=mark-packet chain=prerouting comment="vpn-in packet mark PPTP" in-interface=ether1 new-packet-mark=vpn-in passthrough=no protocol=tcp src-port=1723
add action=mark-packet chain=prerouting comment="vpn-out packet mark PPTP" new-packet-mark=vpn-out passthrough=no protocol=tcp src-port=1723
add action=mark-packet chain=prerouting comment="all in" in-interface=ether1 new-packet-mark=in passthrough=no
add action=mark-packet chain=prerouting comment="all out" new-packet-mark=out passthrough=no
#
# Mangle identifie nos différentes portions de traffic
#
add action=mark-packet chain=prerouting comment="Famille-servers-out packet mark" new-packet-mark=Famille-servers-out passthrough=no src-address-list=Famille-servers
add action=mark-packet chain=prerouting comment="Famille-servers-in packet mark" dst-address-list=Famille-servers new-packet-mark=Famille-servers-in passthrough=no
#
# Ennonce des Queue type
#
/queue type
add kind=pfifo name=streaming-video-in pfifo-limit=500
add kind=pcq name=games-in-pcq pcq-burst-rate=0 pcq-burst-threshold=0 pcq-burst-time=10s pcq-classifier=dst-address pcq-dst-address-mask=32 pcq-dst-address6-mask=64 pcq-limit=50 pcq-rate=100k pcq-src-address-mask=32 pcq-src-address6-mask=64 pcq-total-limit=750000 queue tree
#
#
/queue tree
add burst-limit=0 burst-threshold=0 burst-time=0s disabled=no limit-at=0 max-limit=100M name=in parent=global priority=8
add burst-limit=0 burst-threshold=0 burst-time=0s disabled=no limit-at=0 max-limit=100M name=out parent=global priority=8 queue tree
add max-limit=100M name=in parent=global queue=default
add max-limit=100M name=out parent=global queue=default
add limit-at=3M max-limit=100M name=http-in packet-mark=http-in parent=in priority=4 queue=default
add limit-at=4M max-limit=100M name=streaming-video-in packet-mark=streaming-video-in parent=in priority=3 queue=streaming-video-in
add limit-at=500k max-limit=100M name=gaming-in packet-mark=games-in parent=in priority=2 queue=games-in-pcq
add max-limit=100M name=download-in packet-mark=in parent=in queue=default
add max-limit=100M name=upload-out packet-mark=out parent=out queue=default
add limit-at=500k max-limit=100M name=gaming-out packet-mark=games-out parent=out priority=2 queue=default
add limit-at=3M max-limit=100M name=http-out packet-mark=http-out parent=out priority=4 queue=default
add limit-at=4M max-limit=100M name=streaming-video-out packet-mark=streaming-video-out parent=out priority=3 queue=default
add limit-at=1M max-limit=100M name=Famille-servers-in packet-mark=Famille-servers-in parent=in priority=1 queue=default
add limit-at=1M max-limit=100M name=Famille-servers-out packet-mark=Famille-servers-out parent=out priority=1 queue=default
add limit-at=500k max-limit=100M name=voip-in packet-mark=voip-in parent=in priority=1 queue=default
add limit-at=500k max-limit=100M name=vpn-in packet-mark=vpn-in parent=in priority=2 queue=default
add limit-at=500k max-limit=100M name=voip-out packet-mark=voip-out parent=out priority=1 queue=default
add limit-at=500k max-limit=100M name=vpn-out packet-mark=vpn-out parent=out priority=2 queue=default
add limit-at=500k max-limit=100M name=admin-in packet-mark=admin-in parent=in priority=1 queue=default
add limit-at=500k max-limit=100M name=admin-out packet-mark=admin-out parent=out priority=1 queue=default
#
# L7 Matcher collecte les 10 premiers paquets d'une connexion ou les 2 premiers Ko d'une connexion et recherche le motif dans les données collectées. 
# Si le motif n'est pas trouvé dans les données collectées, le correcteur arrête alors son inspection.
# La mémoire allouée est libérée et le protocole est considéré comme inconnu. Vous devez tenir compte du fait qu'un grand nombre de connexions augmentera
# considérablement l'utilisation de la mémoire et du processeur. Pour éviter cela, ajoutez des filtres de pare-feu réguliers afin de réduire la quantité
# de données transmise aux filtres de couche 7 à plusieurs reprises.
# La condition supplémentaire est que le contrôleur de couche 7 doit voir les deux sens du trafic (entrant et sortant).
# Pour satisfaire à cette exigence,les regles l7 doivent être définies dans une  chaîne en aval. 
# Si la règle est définie dans la chaîne d'entrée / sortie, elle doit également l'être dans la chaîne de sortie / sortie, sinon les données collectées
# risquent de ne pas être complètes, ce qui entraînerait un modèle mal assorti.
# 
# Exemple d'utilisation simple du L7
# Tout d’abord, ajoutez les chaînes Regexp au menu des protocoles pour définir les chaînes que vous recherchez.
#
# Dans cet exemple, nous allons utiliser un modèle pour faire correspondre les paquets rdp.
# 
/ip firewall layer7-protocol
add name=rdp regexp="rdpdr.*cliprdr.*rdpsnd"
add comment="" name=telnet regexp="^\\xff[\\xfb-\\xfe].\\xff[\\xfb-\\xfe].\\xff[\\xfb-\\xfe]"
# Notez que nous avons besoin des deux directions, c’est pourquoi nous avons également besoin de la règle l7 dans la chaîne de sortie qui voit les paquets sortants.
#
# Youtube Matcher 
add name=youtube regexp="(GET \\/videoplayback\\\?|GET \\/crossdomain\\.xml)"
# Remarque: lorsque l'utilisateur est connecté, YouTube utilise HTTPS, ce qui signifie que L7 ne pourra pas correspondre à ce trafic.
# Seul le HTTP non crypté peut être mis en correspondance.
# Add Layer 7 torrent blocking protocols.
# 
# Blocker 100% torrent est impossible car de nos jours de nouvelles applications torrents utilisant la méthode chiffrée les rend presque impossible à inspecter au
# niveau du trafic SSL. J’ai utilisé Forefront TMG 2010 qui est capable d’inspecter le trafic SSL jusqu a un certain point.
# Cependant, nous pouvons bloquer l’accès aux torrents de base en utilisant les éléments suivants.
# (Les motifs ont été récupérés à partir de sources publiques et peu de Mikrotik et quelques tests  personnels .
# Modifié en fonction de vos besoins puis copier et coller, comme nous aimons tous copier coller n’esr ce pas? :p)
add name=commontorrentsites regexp="^.*(get|GET).+(torrent|piratebay|thepiratebay|isohunt|entertane|demonoid|btjunkie|mininova|flixflux|torrentz|vertor|h33t|btscene|bitunity|bittoxic|thunderbytes|entertane|zoozle|vcdq|bitnova|bitsoup|meganova|fulldls|btbot|flixflux|seedpeer|fenopy|gpirate|commonbits).*\$"
#
# ou sous une autre forme. Voici nos déclarations regex l7:
# 
add comment="" name=speedtest-servers regexp="^.*(get|GET).+speedtest.*\$"
add comment="" name=torrent-wwws regexp="^.*(get|GET).+(torrent|thepiratebay|isohunt|entertane|demonoid|btjunkie|mininova|flixflux|vertor|h33t|zoozle|bitnova|bitsoup|meganova|fulldls|btbot|fenopy|gpirate|commonbits).*\$"
add comment="" name=torrent-dns regexp="^.+(torrent|thepiratebay|isohunt|entertane|demonoid|btjunkie|mininova|flixflux|vertor|h33t|zoozle|bitnova|bitsoup|meganova|fulldls|btbot|fenopy|gpirate|commonbits).*\$"
add comment="" name=netflix regexp="^.*(get|GET).+(netflix).*\$"
add comment="" name=mp4 regexp="^.*(get|GET).+\\.mp4.*\$"
add comment="" name=swf regexp="^.*(get|GET).+\\.swf.*\$"
add comment="" name=flv regexp="^.*(get|GET).+\\.flv.*\$"
add name=video regexp="^.*(get|GET).+(\\.flv|\\.mp4|netflix|\\.swf).*\$"

# Ensuite, utilisez les protocoles définis dans le pare-feu.
/ip firewall filter
# ajouter quelques protocoles connus pour réduire l'utilisation de la mémoire 
# 
add action=accept chain=forward comment="" disabled=no port=80 protocol=tcp
add action=accept chain=forward comment="" disabled=no port=8080 protocol=tcp
add action=accept chain=forward comment="" disabled=no port=443 protocol=tcp
add action=accept chain=forward comment="" disabled=no layer7-protocol=rdp protocol=tcp
# Comme vous pouvez le constater avant la règle l7, nous avons ajouté plusieurs règles régulières qui correspondent au trafic connu, réduisant ainsi l’utilisation de la mémoire.
# Dans cet exemple, nous allons essayer de faire correspondre le protocole telnet se connectant à notre routeur. Test Ok ! bon pour Production.
#
# Add System Scheduler for Spamhaus, DShield, and malc0de.
/system scheduler
add comment="Download spamnaus list" interval=3d name=DownloadSpamhausList on-event=DownloadSpamhaus policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon start-date=may/21/2019 start-time=23:41:00
add comment="Apply spamnaus List" interval=3d name=InstallSpamhausList on-event=ReplaceSpamhaus policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon start-date=may/21/2019 start-time=23:46:00
add comment="Download dshield list" interval=3d name=DownloadDShieldList on-event=Download_dshield policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon start-date=may/21/2019 start-time=23:51:00
add comment="Apply dshield List" interval=3d name=InstallDShieldList on-event=Replace_dshield policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon start-date=may/21/2019 start-time=23:56:00
add comment="Download malc0de list" interval=3d name=Downloadmalc0deList on-event=Download_malc0de policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon start-date=may/21/2019 start-time=23:51:00
add comment="Apply malc0de List" interval=3d name=Installmalc0deList on-event=Replace_malc0de policy=ftp,reboot,read,write,policy,test,password,sniff,sensitive,romon start-date=may/21/2019 start-time=23:56:00
#
#
# Ceci est une liste de tous les ports communs trouvés sur http://en.wikipedia.org/wiki/List_of_TCP_and_UDP port_numbers et autres sources.
# Par défaut, ils sont activés pour éviter les problèmes immédiats lors de l'application du script.
# Examinez attentivement la liste des ports et supprimez ou désactivez les entrées inutiles.
#
/ip firewall filter
add action=jump chain=forward comment="Jump to \"Manage Common Ports\" Chain" jump-target="Manage Common Ports"
add chain="Manage Common Ports" comment="\"All hosts on this subnet\" Broadcast" src-address=224.0.0.1
add chain="Manage Common Ports" comment="\"All routers on this subnet\" Broadcast" src-address=224.0.0.2
add chain="Manage Common Ports" comment="DVMRP (Distance Vector Multicast Routing Protocol)" src-address=224.0.0.4
add chain="Manage Common Ports" comment="OSPF - All OSPF Routers Broadcast" src-address=224.0.0.5
add chain="Manage Common Ports" comment="OSPF - OSPF DR Routers Broadcast" src-address=224.0.0.6
add chain="Manage Common Ports" comment="RIP Broadcast" src-address=224.0.0.9
add chain="Manage Common Ports" comment="EIGRP Broadcast" src-address=224.0.0.10
add chain="Manage Common Ports" comment="PIM Broadcast" src-address=224.0.0.13
add chain="Manage Common Ports" comment="VRRP Broadcast" src-address=224.0.0.18
add chain="Manage Common Ports" comment="IS-IS Broadcast" src-address=224.0.0.19
add chain="Manage Common Ports" comment="IS-IS Broadcast" src-address=224.0.0.20
add chain="Manage Common Ports" comment="IS-IS Broadcast" src-address=224.0.0.21
add chain="Manage Common Ports" comment="IGMP Broadcast" src-address=224.0.0.22
add chain="Manage Common Ports" comment="GRE Protocol (Local Management)" protocol=gre
add chain="Manage Common Ports" comment="FTPdata transfer" port=20 protocol=tcp
add chain="Manage Common Ports" comment="FTPdata transfer  " port=20 protocol=udp
add chain="Manage Common Ports" comment="FTPcontrol (command)" port=21 protocol=tcp
add chain="Manage Common Ports" comment="Secure Shell(SSH)" port=22 protocol=tcp
add chain="Manage Common Ports" comment="Secure Shell(SSH)   " port=22 protocol=udp
add chain="Manage Common Ports" comment=Telnet port=23 protocol=tcp
add chain="Manage Common Ports" comment=Telnet port=23 protocol=udp
add chain="Manage Common Ports" comment="Priv-mail: any privatemailsystem." port=24 protocol=tcp
add chain="Manage Common Ports" comment="Priv-mail: any privatemailsystem.  " port=24 protocol=udp
add chain="Manage Common Ports" comment="Simple Mail Transfer Protocol(SMTP)" port=25 protocol=tcp
add chain="Manage Common Ports" comment="Simple Mail Transfer Protocol(SMTP)  " port=25 protocol=udp
add chain="Manage Common Ports" comment="TIME protocol" port=37 protocol=tcp
add chain="Manage Common Ports" comment="TIME protocol  " port=37 protocol=udp
add chain="Manage Common Ports" comment="ARPA Host Name Server Protocol & WINS" port=42 protocol=tcp
add chain="Manage Common Ports" comment="ARPA Host Name Server Protocol  & WINS  " port=42 protocol=udp
add chain="Manage Common Ports" comment="WHOIS protocol" port=43 protocol=tcp
add chain="Manage Common Ports" comment="WHOIS protocol" port=43 protocol=udp
add chain="Manage Common Ports" comment="Domain Name System (DNS)" port=53 protocol=tcp
add chain="Manage Common Ports" comment="Domain Name System (DNS)" port=53 protocol=udp
add chain="Manage Common Ports" comment="Mail Transfer Protocol(RFC 780)" port=57 protocol=tcp
add chain="Manage Common Ports" comment="(BOOTP) Server & (DHCP)  " port=67 protocol=udp
add chain="Manage Common Ports" comment="(BOOTP) Client & (DHCP)  " port=68 protocol=udp
add chain="Manage Common Ports" comment="Trivial File Transfer Protocol (TFTP)  " port=69 protocol=udp
add chain="Manage Common Ports" comment="Gopher protocol" port=70 protocol=tcp
add chain="Manage Common Ports" comment="Finger protocol" port=79 protocol=tcp
add chain="Manage Common Ports" comment="Hypertext Transfer Protocol (HTTP)" port=80 protocol=tcp
add chain="Manage Common Ports" comment="RemoteTELNETService protocol" port=107 protocol=tcp
add chain="Manage Common Ports" comment="Post Office Protocolv2 (POP2)" port=109 protocol=tcp
add chain="Manage Common Ports" comment="Post Office Protocolv3 (POP3)" port=110 protocol=tcp
add chain="Manage Common Ports" comment="IdentAuthentication Service/Identification Protocol" port=113 protocol=tcp
add chain="Manage Common Ports" comment="Authentication Service (auth)  " port=113 protocol=udp
add chain="Manage Common Ports" comment="Simple File Transfer Protocol (SFTP)" port=115 protocol=tcp
add chain="Manage Common Ports" comment="Network Time Protocol(NTP)" port=123 protocol=udp
add chain="Manage Common Ports" comment="NetBIOSNetBIOS Name Service" port=137 protocol=tcp
add chain="Manage Common Ports" comment="NetBIOSNetBIOS Name Service  " port=137 protocol=udp
add chain="Manage Common Ports" comment="NetBIOSNetBIOS Datagram Service" port=138 protocol=tcp
add chain="Manage Common Ports" comment="NetBIOSNetBIOS Datagram Service  " port=138 protocol=udp
add chain="Manage Common Ports" comment="NetBIOSNetBIOS Session Service" port=139 protocol=tcp
add chain="Manage Common Ports" comment="NetBIOSNetBIOS Session Service  " port=139 protocol=udp
add chain="Manage Common Ports" comment="Internet Message Access Protocol (IMAP)" port=143 protocol=tcp
add chain="Manage Common Ports" comment="Background File Transfer Program (BFTP)" port=152 protocol=tcp
add chain="Manage Common Ports" comment="Background File Transfer Program (BFTP)  " port=152 protocol=udp
add chain="Manage Common Ports" comment="SGMP,Simple Gateway Monitoring Protocol" port=153 protocol=tcp
add chain="Manage Common Ports" comment="SGMP,Simple Gateway Monitoring Protocol  " port=153 protocol=udp
add chain="Manage Common Ports" comment="DMSP, Distributed Mail Service Protocol" port=158 protocol=tcp
add chain="Manage Common Ports" comment="DMSP, Distributed Mail Service Protocol  " port=158 protocol=udp
add chain="Manage Common Ports" comment="Simple Network Management Protocol(SNMP)  " port=161 protocol=udp
add chain="Manage Common Ports" comment="Simple Network Management ProtocolTrap (SNMPTRAP)" port=162 protocol=tcp
add chain="Manage Common Ports" comment="Simple Network Management ProtocolTrap (SNMPTRAP)  " port=162 protocol=udp
add chain="Manage Common Ports" comment="BGP (Border Gateway Protocol)" port=179 protocol=tcp
add chain="Manage Common Ports" comment="Internet Message Access Protocol (IMAP), version 3" port=220 protocol=tcp
add chain="Manage Common Ports" comment="Internet Message Access Protocol (IMAP), version 3" port=220 protocol=udp
add chain="Manage Common Ports" comment="BGMP, Border Gateway Multicast Protocol" port=264 protocol=tcp
add chain="Manage Common Ports" comment="BGMP, Border Gateway Multicast Protocol  " port=264 protocol=udp
add chain="Manage Common Ports" comment="Lightweight Directory Access Protocol (LDAP)" port=389 protocol=tcp
add chain="Manage Common Ports" comment="Lightweight Directory Access Protocol (LDAP)" port=389 protocol=udp
add chain="Manage Common Ports" comment="SSTP TCP Port 443 (Local Management) & HTTPS" port=443 protocol=tcp
add chain="Manage Common Ports" comment="Microsoft-DSActive Directory, Windows shares" port=445 protocol=tcp
add chain="Manage Common Ports" comment="L2TP/ IPSEC UDP Port 500 (Local Management)" port=500 protocol=udp
add chain="Manage Common Ports" comment="Modbus, Protocol" port=502 protocol=tcp
add chain="Manage Common Ports" comment="Modbus, Protocol  " port=502 protocol=udp
add chain="Manage Common Ports" comment="Shell (Remote Shell, rsh, remsh)" port=514 protocol=tcp
add chain="Manage Common Ports" comment="Syslog - used for system logging  " port=514 protocol=udp
add chain="Manage Common Ports" comment="Routing Information Protocol (RIP)  " port=520 protocol=udp
add chain="Manage Common Ports" comment="e-mail message submission (SMTP)" port=587 protocol=tcp
add chain="Manage Common Ports" comment="LDP,Label Distribution Protocol" port=646 protocol=tcp
add chain="Manage Common Ports" comment="LDP,Label Distribution Protocol" port=646 protocol=udp
add chain="Manage Common Ports" comment="FTPS Protocol (data):FTP over TLS/SSL" port=989 protocol=tcp
add chain="Manage Common Ports" comment="FTPS Protocol (data):FTP over TLS/SSL" port=989 protocol=udp
add chain="Manage Common Ports" comment="FTPS Protocol (control):FTP over TLS/SSL" port=990 protocol=tcp
add chain="Manage Common Ports" comment="FTPS Protocol (control):FTP over TLS/SSL" port=990 protocol=udp
add chain="Manage Common Ports" comment="TELNET protocol overTLS/SSL" port=992 protocol=tcp
add chain="Manage Common Ports" comment="TELNET protocol overTLS/SSL" port=992 protocol=udp
add chain="Manage Common Ports" comment="Internet Message Access Protocol over TLS/SSL (IMAPS)" port=993 protocol=tcp
add chain="Manage Common Ports" comment="Post Office Protocol3 over TLS/SSL (POP3S)" port=995 protocol=tcp
add chain="Manage Common Ports" comment="OVPN TCP Port 1194 (Local Management)" port=1194 protocol=tcp
add chain="Manage Common Ports" comment="PPTP Port 1723 (Local Management)" port=1723 protocol=tcp
add chain="Manage Common Ports" comment="L2TP UDP Port 1701 (Local Management)" port=1701 protocol=udp
add chain="Manage Common Ports" comment="L2TP UDP Port 4500 (Local Management)" port=4500 protocol=udp
#
/ip firewall filter
add chain=input comment="Accept Related or Established Connections" connection-state=established,related disabled=yes
add chain=forward comment="Accept New Connections" connection-state=new disabled=yes
add chain=forward comment="Accept Related or Established Connections" connection-state=established,related disabled=yes

#
/ipv6 firewall filter
add chain=input action=drop connection-state=invalid comment="Drop (invalid)"
add chain=input action=accept connection-state=established,related comment="Accept (established, related)"
add chain=input action=accept in-interface=ether1protocol=udp src-port=547 limit=10,20:packet comment="Accept DHCP (10/sec)"
add chain=input action=drop in-interface=ether1 protocol=udp src-port=547 comment="Drop DHCP (>10/sec)"
add chain=input action=accept in-interface=ether1 protocol=icmpv6 limit=10,20:packet comment="Accept external ICMP (10/sec)"
add chain=input action=drop in-interface=ether1 protocol=icmpv6 comment="Drop external ICMP (>10/sec)"
add chain=input action=accept in-interface=!ether1 protocol=icmpv6 comment="Accept internal ICMP"
add chain=input action=drop in-interface=ether1 comment="Drop external"
add chain=input action=reject comment="Reject everything else"
add chain=output action=accept comment="Accept all"
add chain=forward action=drop connection-state=invalid comment="Drop (invalid)"
add chain=forward action=accept connection-state=established,related comment="Accept (established, related)"
add chain=forward action=accept in-interface=ether1 protocol=icmpv6 limit=20,50:packet comment="Accept external ICMP (20/sec)"
add chain=forward action=drop in-interface=ether1 protocol=icmpv6 comment="Drop external ICMP (>20/sec)"
add chain=forward action=accept in-interface=!ether1 comment="Accept internal"
add chain=forward action=accept out-interface=ether1-WAN comment="Accept outgoing"
add chain=forward action=drop in-interface=ether1 comment="Drop external"
add chain=forward action=reject comment="Reject everything else"


